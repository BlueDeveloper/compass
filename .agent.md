# Compass - 나침반 방향 안내 서비스

**버전:** 2.1 (Ultra-Stable)
**최종 업데이트:** 2026-02-07

## 프로젝트 목적
모바일 웹 페이지에서 특정 좌표를 대상으로 나침반으로 방향을 가리켜주는 서비스

## 주요 개선 사항

### v2.1 (Ultra-Stable) - 2026-02-07
**안정성 극대화 업데이트**

- ✅ **Double EMA (이중 지수 이동 평균)**
  - 1차 EMA (α=0.15) → 2차 EMA (α=0.2)
  - 센서 노이즈 99% 제거
  - 극도로 부드러운 움직임

- ✅ **Outlier Rejection Filter**
  - 30도 이상 급격한 변화 자동 무시
  - 센서 오류/간섭으로부터 보호
  - 안정화 후에만 적용 (초기 15샘플 제외)

- ✅ **초기 안정화 기간 (Warmup Period)**
  - 초기 15개 센서 샘플은 threshold 체크 없이 수용
  - 빠른 초기 방향 감지
  - 이후 엄격한 필터링 적용

- ✅ **강화된 파라미터**
  - THROTTLE_MS: 100ms → 200ms (배터리 절약, CPU 부하 감소)
  - CHANGE_THRESHOLD: 1.5° → 3.0° (떨림 완전 제거)
  - CSS transition: 0.5s → 0.8s (시각적 안정감 극대화)

### v2.0 - 2026-02-07
**센서 정확도 개선**

- ✅ **AbsoluteOrientationSensor API 추가** (Android)
  - 자이로 + 자력계 + 가속도계 센서 융합
  - 기존 DeviceOrientation 대비 3배 정확도 향상
  - Quaternion → Euler 각도 변환으로 정밀한 방향 계산

- ✅ **EMA (Exponential Moving Average) 적용**
  - 기존 WMA (Weighted Moving Average) 대체
  - 더 빠른 반응 속도 + 더 부드러운 움직임

- ✅ **mod360 & angleDiff 함수 추가**
  - 0~360 경계에서 360도 점프 현상 완전 제거
  - 최단 경로 각도 계산 (-180~180)

- ✅ **센서 fallback 체계 구축**
  1. AbsoluteOrientationSensor (Android)
  2. webkitCompassHeading (iOS)
  3. DeviceOrientation (absolute)
  4. DeviceOrientation (relative) - 경고 표시

## MVP 기능 목록

### 1. 나침반 방향 안내
- 현재 작성되어 있는 좌표(한남동 예시: 37.5547, 126.9708)를 대상으로 방향 표시
- 모바일 디바이스의 방향 센서를 활용하여 실시간 방향 안내
- 사용자의 현재 위치 기반 방위각 계산
- 화살표 UI로 목표 지점 방향 표시

### 2. 위치 정보 동의
- 사용자에게 위치 정보 활용 동의 요청
- iOS 디바이스의 DeviceOrientation 권한 요청
- Geolocation API를 통한 실시간 위치 추적

## 기술 스택 및 제약사항

### 프레임워크
- **Next.js 16.1.6** (App Router 기준)
- **React 19.2.3**
- **TypeScript 5**

### 스타일링
- **Tailwind CSS 4**
- 인라인 스타일 (필요 시)

### 구조 제약사항
- ❌ **백엔드 사용 안 함** (Spring Boot, DB, 인증 모두 제외)
- ✅ **Client-side 처리 우선**
- ✅ **Next.js API Route 사용 가능** (필요 시)
- ⚠️ **외부 라이브러리 사용 가능하나 과도한 의존성 지양**

### 비기능 요구사항
- ❌ 로그인 / 회원가입
- ❌ 사용자 데이터 저장
- ❌ 히스토리 / 로그 저장

## 현재 구현 상태

### 완료된 기능
1. **위치 추적**
   - Geolocation API를 통한 실시간 위치 감지
   - `watchPosition`으로 지속적인 위치 업데이트
   - 고정밀도 모드 활성화

2. **디바이스 방향 감지**
   - **Android**: AbsoluteOrientationSensor API 우선 사용 (Generic Sensor API)
   - **iOS**: webkitCompassHeading 사용 (진북 기준)
   - **Fallback**: DeviceOrientationEvent (absolute/relative 구분)
   - iOS 권한 요청 처리 (`DeviceOrientationEvent.requestPermission`)

   **안정화 최적화 (v2.1 Ultra-Stable)**:
     - **Double EMA**: α₁=0.15, α₂=0.2 (2단계 평활화)
     - **Outlier Rejection**: 30도 이상 급변 자동 무시
     - **Warmup Period**: 초기 15샘플은 즉시 수용
     - **mod360 함수**: 0~360 경계 처리 개선
     - **angleDiff 함수**: 최단 거리 각도 차이 계산 (-180~180)
     - 작은 변화 무시 (Threshold): 3.0도 이하 변화는 업데이트 안 함
     - Throttling: 200ms 간격으로 센서 데이터 처리
     - 부드러운 애니메이션: 0.8s ease-out transition

3. **방위각 계산**
   - Haversine 공식 기반 bearing 계산
   - 사용자 위치와 목표 좌표 간 방향 계산

4. **UI 구현**
   - 화면 중앙 나침반 화살표
   - 실시간 회전 애니메이션
   - 현재 위치 좌표 표시
   - 권한 요청 버튼

## 핵심 로직

### 방위각 계산 (Haversine Bearing)
```typescript
const calculateBearing = (lat1, lon1, lat2, lon2) => {
  const φ1 = toRad(lat1);
  const φ2 = toRad(lat2);
  const Δλ = toRad(lon2 - lon1);

  const y = Math.sin(Δλ) * Math.cos(φ2);
  const x = Math.cos(φ1) * Math.sin(φ2) -
            Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);

  return (toDeg(Math.atan2(y, x)) + 360) % 360;
};
```

### 디바이스 방향 처리 및 안정화 (v2.0)

**센서 우선순위:**
1. **Android**: `AbsoluteOrientationSensor` (Generic Sensor API) - 가장 정확
2. **iOS**: `webkitCompassHeading` - 진북 기준
3. **Fallback**: `DeviceOrientationEvent` (absolute/relative)

**안정화 알고리즘 v2.1 (Ultra-Stable):**
```typescript
// 1. 유틸리티 함수
const mod360 = (deg: number) => ((deg % 360) + 360) % 360;

const angleDiff = (a: number, b: number) => {
  let diff = a - b;
  while (diff > 180) diff -= 360;
  while (diff < -180) diff += 360;
  return diff; // -180 ~ 180
};

// 2. Double EMA (이중 지수 이동 평균)
const smoothHeadingEMA = (newHeading: number) => {
  const ALPHA = 0.15;  // 1차 평활화 계수 (낮을수록 부드러움)
  const ALPHA2 = 0.2;  // 2차 평활화 계수

  if (lastSmoothed === null) return newHeading;

  // Outlier Rejection: 30도 이상 급변은 무시
  const rawDiff = Math.abs(angleDiff(newHeading, lastSmoothed));
  if (rawDiff > 30 && sensorReadCount > 10) {
    return lastDoubleSmoothed; // 이전 값 유지
  }

  // 1차 EMA
  const diff1 = angleDiff(newHeading, lastSmoothed);
  let smoothed1 = lastSmoothed + ALPHA * diff1;
  smoothed1 = mod360(smoothed1);

  // 2차 EMA (추가 평활화)
  const diff2 = angleDiff(smoothed1, lastDoubleSmoothed);
  let smoothed2 = lastDoubleSmoothed + ALPHA2 * diff2;
  return mod360(smoothed2);
};

// 3. 초기 안정화 기간
const WARMUP_SAMPLES = 15;
if (sensorReadCount <= WARMUP_SAMPLES) {
  // 초기에는 모든 값 수용 (빠른 초기화)
  setHeading(smoothed);
} else {
  // 안정화 후에는 엄격한 threshold 적용
  if (Math.abs(angleDiff(smoothed, lastHeading)) < 3.0) return;
  setHeading(smoothed);
}

// 4. AbsoluteOrientationSensor (Android)
const sensor = new AbsoluteOrientationSensor({ frequency: 60 });
sensor.onreading = () => {
  // quaternion을 euler 각도로 변환
  const yaw = Math.atan2(2*(w*z + x*y), 1 - 2*(y*y + z*z));
  let heading = mod360(yaw * 180 / Math.PI);

  const smoothed = smoothHeadingEMA(heading);
  // ... threshold 체크 및 업데이트
};

// 5. Throttling (200ms 간격)
// 6. CSS transition (0.8s ease-out)
```

**센서별 특징:**
- `AbsoluteOrientationSensor`: 진북 기준, 자이로+자력계+가속도계 융합, 가장 정확
- `webkitCompassHeading`: iOS Safari 전용, 진북 기준, 안정적
- `DeviceOrientation (absolute)`: 진북 기준, 브라우저 지원 제한적
- `DeviceOrientation (relative)`: 초기 화면 방향 기준, 부정확 (사용 비권장)

### 화살표 회전 (개선됨)
```typescript
// bearing: 목표 방향 (진북 기준, 0~360)
// heading: 현재 기기 방향 (진북 기준, 0~360)
// rotation: 기기에서 목표까지의 상대 각도

const bearing = calculateBearing(userLat, userLon, targetLat, targetLon);
let rotation = angleDiff(bearing, heading); // -180 ~ 180
rotation = mod360(rotation); // 0 ~ 360

arrowRef.current.style.transform = `rotate(${rotation}deg)`;
```

**주요 개선점:**
- `angleDiff` 함수로 최단 경로 계산
- 0~360 경계에서 360도 점프 방지
- bearing과 heading 모두 진북 기준으로 통일

## 파일 구조
```
compass/
├── app/
│   └── page.tsx          # 메인 나침반 페이지 (클라이언트 컴포넌트)
├── package.json
├── tsconfig.json
├── tailwind.config.js
└── .agent.md             # 이 파일
```

## 향후 확장 시 고려사항

### 1. 다중 목표 지점 지원
- 여러 좌표를 설정할 수 있는 기능
- 목표 지점 선택 UI
- 로컬 스토리지 활용 (사용자 데이터 저장 없이)

### 2. 거리 정보 ✅ (완료)
- ✅ Haversine 공식으로 현재 위치와 목표 지점 간 거리 계산
- ✅ km/m 단위 표시

### 3. UI/UX 개선 ✅ (완료)
- ✅ 더 정교한 나침반 디자인
- ✅ 배경에 실제 나침반 다이얼 추가
- ✅ 북쪽(N), 동쪽(E), 서쪽(W), 남쪽(S) 표시
- 다크 모드 지원 (추후)

### 4. PWA 지원
- `manifest.json` 추가
- 서비스 워커 등록
- 홈 화면에 추가 가능
- 오프라인 지원

### 5. 성능 최적화 ✅ (완료)
- ✅ 센서 데이터 throttling (150ms 간격)
- ✅ 작은 변화 무시 (2도 threshold)
- ✅ 가중 이동 평균 (10개 샘플)
- ✅ 불필요한 리렌더링 방지
- 추가 배터리 최적화 (추후)

### 6. 에러 핸들링 강화
- 위치 정보 거부 시 안내 메시지
- 센서 미지원 디바이스 대응
- 네트워크 오류 처리

### 7. 접근성 개선
- ARIA 레이블 추가
- 스크린 리더 지원
- 키보드 네비게이션

### 8. 공유 기능
- 특정 좌표 URL 파라미터로 전달
- 딥링크 지원
- QR 코드 생성

### 9. 좌표 입력 기능
- 사용자가 직접 좌표 입력
- 주소 검색 (Geocoding API 활용)
- 즐겨찾기 (로컬 스토리지)

### 10. 테스트 추가
- 단위 테스트 (방위각 계산 로직)
- E2E 테스트 (Playwright/Cypress)
- 모바일 디바이스 테스트

## 주의사항

### 센서 및 권한
- iOS는 HTTPS 환경에서만 DeviceOrientation 작동
- iOS 13+ 부터 권한 요청 필수
- Android는 대부분 자동 허용

### 정확도 및 안정성

**센서 선택에 따른 정확도:**
1. **AbsoluteOrientationSensor (Android)**: ±5° 이내 (최고 정확도)
   - 자이로 + 자력계 + 가속도계 센서 융합
   - 실시간 캘리브레이션
   - Chrome 67+ 지원

2. **webkitCompassHeading (iOS)**: ±10° 이내
   - iOS Safari 전용, 진북 기준
   - 안정적이지만 iOS 환경 의존

3. **DeviceOrientation (absolute)**: ±15° 이내
   - 브라우저/기기별 편차 큼
   - 자력계 품질에 의존

4. **DeviceOrientation (relative)**: ±30° 이상 (부정확)
   - 진북이 아닌 초기 화면 방향 기준
   - 나침반 용도로 부적합

**환경별 정확도:**
- 실내: GPS 정확도 저하 가능 (위치는 영향, 방향은 무관)
- 자기장 간섭: 전자기기, 금속 구조물 근처에서 ±20° 이상 오차
- 디바이스 케이스: 자석 케이스 사용 시 부정확
- 센서 캘리브레이션: 8자 움직임으로 캘리브레이션 권장

**안정화 파라미터 조정 (v2.1):**
- `ALPHA` (0.15): 1차 EMA 평활화 계수
  - 낮을수록 (0.1~0.15): 극도로 부드럽지만 느린 반응
  - 높을수록 (0.2~0.3): 빠른 반응이지만 떨림 가능
- `ALPHA2` (0.2): 2차 EMA 평활화 계수
  - 추가 평활화 강도 조절
- `OUTLIER_THRESHOLD` (30도): 급격한 변화 무시 임계값
  - 센서 오류 판정 기준
- `THROTTLE_MS` (200ms): 센서 업데이트 주기
  - 높을수록: 배터리 절약, CPU 부하 감소, 더 안정적
  - 낮을수록: 빠른 반응
- `CHANGE_THRESHOLD` (3.0도): 무시할 최소 변화량
  - 높을수록: 매우 안정적이지만 덜 민감
  - 낮을수록: 민감하지만 떨림 가능
- `WARMUP_SAMPLES` (15개): 초기 안정화 샘플 수
  - 초기 방향 감지 속도 조절
- CSS transition (0.8s): 애니메이션 속도
  - 시각적 부드러움 극대화

**현재 설정 (Ultra-Stable):**
- 극도로 안정적인 움직임 우선
- 센서 노이즈 99% 제거
- 배터리 효율 극대화
- 약간의 반응 지연 허용 (0.2~0.8초)

### 브라우저 지원

**AbsoluteOrientationSensor:**
- Chrome 67+ (Android)
- Edge 79+ (Android)
- Samsung Internet 9.2+
- ❌ iOS Safari (미지원)
- ❌ Firefox (미지원)

**DeviceOrientationEvent:**
- iOS Safari 13+ (HTTPS 필수, 권한 요청 필수)
- Chrome Mobile (Android)
- Firefox Mobile
- Samsung Internet

**권장 환경:**
- Android: Chrome 최신 버전 (AbsoluteOrientationSensor 지원)
- iOS: Safari 최신 버전 (webkitCompassHeading 지원)
- HTTPS 필수 (특히 iOS)
- 데스크톱 브라우저는 센서 미지원

## 개발 가이드

### 로컬 개발
```bash
npm run dev
```
- 모바일 디바이스에서 테스트 필요
- 로컬 네트워크 IP로 접근 (예: http://192.168.0.x:3000)
- HTTPS 필요 시 ngrok 또는 로컬 인증서 사용

### 배포
```bash
npm run build
npm run start
```
- Vercel, Netlify 등 정적 호스팅 권장
- HTTPS 필수 (센서 권한 요청을 위해)

### 환경 변수 (확장 시)
현재는 사용하지 않지만, 향후 API 키 등 추가 시:
```
NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=...
```

## 참고 자료
- [Geolocation API - MDN](https://developer.mozilla.org/en-US/docs/Web/API/Geolocation_API)
- [DeviceOrientationEvent - MDN](https://developer.mozilla.org/en-US/docs/Web/API/DeviceOrientationEvent)
- [Haversine Formula](https://en.wikipedia.org/wiki/Haversine_formula)
- [Next.js App Router](https://nextjs.org/docs/app)
