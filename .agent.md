# Compass - 나침반 방향 안내 서비스

## 프로젝트 목적
모바일 웹 페이지에서 특정 좌표를 대상으로 나침반으로 방향을 가리켜주는 서비스

## MVP 기능 목록

### 1. 나침반 방향 안내
- 현재 작성되어 있는 좌표(한남동 예시: 37.5547, 126.9708)를 대상으로 방향 표시
- 모바일 디바이스의 방향 센서를 활용하여 실시간 방향 안내
- 사용자의 현재 위치 기반 방위각 계산
- 화살표 UI로 목표 지점 방향 표시

### 2. 위치 정보 동의
- 사용자에게 위치 정보 활용 동의 요청
- iOS 디바이스의 DeviceOrientation 권한 요청
- Geolocation API를 통한 실시간 위치 추적

## 기술 스택 및 제약사항

### 프레임워크
- **Next.js 16.1.6** (App Router 기준)
- **React 19.2.3**
- **TypeScript 5**

### 스타일링
- **Tailwind CSS 4**
- 인라인 스타일 (필요 시)

### 구조 제약사항
- ❌ **백엔드 사용 안 함** (Spring Boot, DB, 인증 모두 제외)
- ✅ **Client-side 처리 우선**
- ✅ **Next.js API Route 사용 가능** (필요 시)
- ⚠️ **외부 라이브러리 사용 가능하나 과도한 의존성 지양**

### 비기능 요구사항
- ❌ 로그인 / 회원가입
- ❌ 사용자 데이터 저장
- ❌ 히스토리 / 로그 저장

## 현재 구현 상태

### 완료된 기능
1. **위치 추적**
   - Geolocation API를 통한 실시간 위치 감지
   - `watchPosition`으로 지속적인 위치 업데이트
   - 고정밀도 모드 활성화

2. **디바이스 방향 감지**
   - DeviceOrientationEvent 활용
   - iOS 권한 요청 처리 (`DeviceOrientationEvent.requestPermission`)
   - Android/iOS 모두 지원 (webkitCompassHeading 포함)
   - **안정화 최적화**:
     - 가중 이동 평균 (Weighted Moving Average): 최근 10개 값 사용
     - 작은 변화 무시 (Threshold): 2도 이하 변화는 업데이트 안 함
     - Throttling: 150ms 간격으로 센서 데이터 처리
     - 부드러운 애니메이션: 0.5s ease-out transition

3. **방위각 계산**
   - Haversine 공식 기반 bearing 계산
   - 사용자 위치와 목표 좌표 간 방향 계산

4. **UI 구현**
   - 화면 중앙 나침반 화살표
   - 실시간 회전 애니메이션
   - 현재 위치 좌표 표시
   - 권한 요청 버튼

## 핵심 로직

### 방위각 계산 (Haversine Bearing)
```typescript
const calculateBearing = (lat1, lon1, lat2, lon2) => {
  const φ1 = toRad(lat1);
  const φ2 = toRad(lat2);
  const Δλ = toRad(lon2 - lon1);

  const y = Math.sin(Δλ) * Math.cos(φ2);
  const x = Math.cos(φ1) * Math.sin(φ2) -
            Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);

  return (toDeg(Math.atan2(y, x)) + 360) % 360;
};
```

### 디바이스 방향 처리 및 안정화
- iOS: `webkitCompassHeading` (절대 방향)
- Android: `event.alpha` 값을 360도에서 뺀 값
- `deviceorientationabsolute` 이벤트 우선 사용

**안정화 알고리즘:**
```typescript
// 1. 가중 이동 평균 (최근 10개 값)
const smoothHeading = (newHeading: number) => {
  // 0도/360도 경계 처리
  // 최근 값에 더 높은 가중치 부여
  let weightedSum = 0, weightTotal = 0;
  for (let i = 0; i < history.length; i++) {
    const weight = i + 1;
    weightedSum += history[i] * weight;
    weightTotal += weight;
  }
  return weightedSum / weightTotal;
};

// 2. 작은 변화 무시 (2도 threshold)
if (Math.abs(smoothedHeading - lastHeading) < 2) {
  return; // 업데이트하지 않음
}

// 3. Throttling (150ms 간격)
// 4. CSS transition (0.5s ease-out)
```

### 화살표 회전
```typescript
const rotation = bearing - heading;
arrowRef.current.style.transform = `rotate(${rotation}deg)`;
```

## 파일 구조
```
compass/
├── app/
│   └── page.tsx          # 메인 나침반 페이지 (클라이언트 컴포넌트)
├── package.json
├── tsconfig.json
├── tailwind.config.js
└── .agent.md             # 이 파일
```

## 향후 확장 시 고려사항

### 1. 다중 목표 지점 지원
- 여러 좌표를 설정할 수 있는 기능
- 목표 지점 선택 UI
- 로컬 스토리지 활용 (사용자 데이터 저장 없이)

### 2. 거리 정보 ✅ (완료)
- ✅ Haversine 공식으로 현재 위치와 목표 지점 간 거리 계산
- ✅ km/m 단위 표시

### 3. UI/UX 개선 ✅ (완료)
- ✅ 더 정교한 나침반 디자인
- ✅ 배경에 실제 나침반 다이얼 추가
- ✅ 북쪽(N), 동쪽(E), 서쪽(W), 남쪽(S) 표시
- 다크 모드 지원 (추후)

### 4. PWA 지원
- `manifest.json` 추가
- 서비스 워커 등록
- 홈 화면에 추가 가능
- 오프라인 지원

### 5. 성능 최적화 ✅ (완료)
- ✅ 센서 데이터 throttling (150ms 간격)
- ✅ 작은 변화 무시 (2도 threshold)
- ✅ 가중 이동 평균 (10개 샘플)
- ✅ 불필요한 리렌더링 방지
- 추가 배터리 최적화 (추후)

### 6. 에러 핸들링 강화
- 위치 정보 거부 시 안내 메시지
- 센서 미지원 디바이스 대응
- 네트워크 오류 처리

### 7. 접근성 개선
- ARIA 레이블 추가
- 스크린 리더 지원
- 키보드 네비게이션

### 8. 공유 기능
- 특정 좌표 URL 파라미터로 전달
- 딥링크 지원
- QR 코드 생성

### 9. 좌표 입력 기능
- 사용자가 직접 좌표 입력
- 주소 검색 (Geocoding API 활용)
- 즐겨찾기 (로컬 스토리지)

### 10. 테스트 추가
- 단위 테스트 (방위각 계산 로직)
- E2E 테스트 (Playwright/Cypress)
- 모바일 디바이스 테스트

## 주의사항

### 센서 및 권한
- iOS는 HTTPS 환경에서만 DeviceOrientation 작동
- iOS 13+ 부터 권한 요청 필수
- Android는 대부분 자동 허용

### 정확도 및 안정성
- 나침반 정확도는 디바이스 센서 품질에 의존
- 실내에서는 GPS 정확도 저하 가능
- 자기장 간섭 주의 (전자기기 근처)

**안정화 파라미터 조정:**
- `THROTTLE_MS` (150ms): 센서 업데이트 주기 (높일수록 느리지만 안정적)
- `CHANGE_THRESHOLD` (2도): 무시할 최소 변화량 (높일수록 안정적이지만 덜 민감)
- 평활화 window (10개): 평균 계산에 사용할 샘플 수 (높일수록 부드럽지만 느린 반응)
- CSS transition (0.5s): 애니메이션 속도 (높일수록 부드럽지만 느린 반응)

### 브라우저 지원
- 모던 브라우저에서만 지원 (Safari, Chrome Mobile)
- 데스크톱 브라우저는 센서 미지원

## 개발 가이드

### 로컬 개발
```bash
npm run dev
```
- 모바일 디바이스에서 테스트 필요
- 로컬 네트워크 IP로 접근 (예: http://192.168.0.x:3000)
- HTTPS 필요 시 ngrok 또는 로컬 인증서 사용

### 배포
```bash
npm run build
npm run start
```
- Vercel, Netlify 등 정적 호스팅 권장
- HTTPS 필수 (센서 권한 요청을 위해)

### 환경 변수 (확장 시)
현재는 사용하지 않지만, 향후 API 키 등 추가 시:
```
NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=...
```

## 참고 자료
- [Geolocation API - MDN](https://developer.mozilla.org/en-US/docs/Web/API/Geolocation_API)
- [DeviceOrientationEvent - MDN](https://developer.mozilla.org/en-US/docs/Web/API/DeviceOrientationEvent)
- [Haversine Formula](https://en.wikipedia.org/wiki/Haversine_formula)
- [Next.js App Router](https://nextjs.org/docs/app)
