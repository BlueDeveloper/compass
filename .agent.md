# Compass - 나침반 방향 안내 서비스

**버전:** 2.4 (Radar Mode)
**최종 업데이트:** 2026-02-07

## 프로젝트 목적
모바일 웹 페이지에서 특정 좌표를 대상으로 나침반으로 방향을 가리켜주는 서비스

## 주요 개선 사항

### v2.4 (Radar Mode) - 2026-02-07
**레이더 모드 추가 및 UI 단순화**

- ✅ **레이더 모드 페이지 추가** (`/radar`)
  - 원형 레이더 UI (SVG 기반)
  - 중앙에 사용자 고정 (파란색 점)
  - 목표 지점을 상대 위치로 표시 (빨간색 점)
  - 실시간 추적 및 펄스 애니메이션
  - 목표까지의 거리선 표시

- ✅ **자동 줌 조정**
  - 거리에 따라 자동 줌 레벨 조정
    - < 0.5km: 줌 3x
    - < 1km: 줌 2x
    - < 3km: 줌 1x
    - < 5km: 줌 0.7x
    - ≥ 5km: 줌 0.5x
  - 수동 줌인/줌아웃 버튼 (0.3x ~ 5x)

- ✅ **레이더 UI 요소**
  - 3개 동심원 (120px, 80px, 40px)
  - 십자선 (N/E/S/W)
  - 북쪽 표시 (N)
  - 방위각 정보 표시
  - 거리 및 줌 레벨 표시

- ✅ **나침반 모드 UI 단순화**
  - 과도한 애니메이션 제거
    - Pulse 효과 제거
    - 색상 변경 제거
    - 글로우 효과 제거
  - 심플한 방향 안내 카드
  - 기본 빨간색 화살표 유지

- ✅ **모드 전환 네비게이션**
  - 나침반 ↔ 레이더 모드 전환 버튼
  - 각 모드의 특성에 맞는 UI/UX

### v2.3 (Fast Response) - 2026-02-07
**빠른 반응 속도 최적화 (벤치마킹: onlinecompass2.com)**

- ✅ **Single EMA로 단순화**
  - Double EMA → Single EMA
  - 2단계 평활화 제거로 **반응 속도 2배 향상**
  - ALPHA: 0.15/0.2 → 0.35 (빠른 반응)

- ✅ **센서 업데이트 주기 단축**
  - THROTTLE_MS: 200ms → 50ms (**4배 빠름**)
  - 초당 20회 업데이트
  - 실시간 반응

- ✅ **민감도 대폭 증가**
  - CHANGE_THRESHOLD: 3.0° → 0.5° (**6배 민감**)
  - 작은 움직임도 즉시 반영
  - 정밀한 방향 추적

- ✅ **Outlier 필터 완화**
  - 30° → 60° (급격한 방향 전환 허용)
  - 빠른 회전에도 반응

- ✅ **애니메이션 속도 향상**
  - CSS transition: 0.8s → 0.2s (**4배 빠름**)
  - 즉각적인 시각적 피드백

**결과:** 벤치마크 사이트 수준의 빠른 반응 속도 달성

### v2.2 (Clear Direction) - 2026-02-07
**방향 표시 명확성 극대화**

- ✅ **실시간 방향 안내 텍스트**
  - "목표 방향! 직진하세요" (±15° 이내)
  - "거의 다 왔어요! 오른쪽으로 조금" (±30° 이내)
  - "오른쪽으로 45°" (±60° 이내)
  - "오른쪽으로 크게 돌아주세요" (±120° 이내)
  - "뒤돌아 가세요" (120° 초과)

- ✅ **시각적 정렬 피드백**
  - 정렬 시 화살표 색상: 빨간색 → 초록색
  - 정렬 시 외곽 테두리: 회색 → 초록색 (발광 효과)
  - 정렬 시 애니메이션 링 (pulse 효과)
  - 정렬 시 외곽 글로우 (glow) 효과

- ✅ **방위각 정보 표시**
  - 현재 방향 vs 목표 방향 (숫자로 표시)
  - 회전해야 할 각도 실시간 표시
  - 2열 그리드 레이아웃으로 한눈에 비교

- ✅ **UI 개선**
  - 방향 안내 카드 (이모지 + 텍스트)
  - 정렬 상태에 따른 카드 색상 변경
  - 상세 정보 아코디언 (접기/펼치기)
  - 더 큰 화살표, 더 굵은 테두리

### v2.1 (Ultra-Stable) - 2026-02-07
**안정성 극대화 업데이트**

- ✅ **Double EMA (이중 지수 이동 평균)**
  - 1차 EMA (α=0.15) → 2차 EMA (α=0.2)
  - 센서 노이즈 99% 제거
  - 극도로 부드러운 움직임

- ✅ **Outlier Rejection Filter**
  - 30도 이상 급격한 변화 자동 무시
  - 센서 오류/간섭으로부터 보호
  - 안정화 후에만 적용 (초기 15샘플 제외)

- ✅ **초기 안정화 기간 (Warmup Period)**
  - 초기 15개 센서 샘플은 threshold 체크 없이 수용
  - 빠른 초기 방향 감지
  - 이후 엄격한 필터링 적용

- ✅ **강화된 파라미터**
  - THROTTLE_MS: 100ms → 200ms (배터리 절약, CPU 부하 감소)
  - CHANGE_THRESHOLD: 1.5° → 3.0° (떨림 완전 제거)
  - CSS transition: 0.5s → 0.8s (시각적 안정감 극대화)

### v2.0 - 2026-02-07
**센서 정확도 개선**

- ✅ **AbsoluteOrientationSensor API 추가** (Android)
  - 자이로 + 자력계 + 가속도계 센서 융합
  - 기존 DeviceOrientation 대비 3배 정확도 향상
  - Quaternion → Euler 각도 변환으로 정밀한 방향 계산

- ✅ **EMA (Exponential Moving Average) 적용**
  - 기존 WMA (Weighted Moving Average) 대체
  - 더 빠른 반응 속도 + 더 부드러운 움직임

- ✅ **mod360 & angleDiff 함수 추가**
  - 0~360 경계에서 360도 점프 현상 완전 제거
  - 최단 경로 각도 계산 (-180~180)

- ✅ **센서 fallback 체계 구축**
  1. AbsoluteOrientationSensor (Android)
  2. webkitCompassHeading (iOS)
  3. DeviceOrientation (absolute)
  4. DeviceOrientation (relative) - 경고 표시

## MVP 기능 목록

### 1. 나침반 방향 안내
- 현재 작성되어 있는 좌표(한남동 예시: 37.5547, 126.9708)를 대상으로 방향 표시
- 모바일 디바이스의 방향 센서를 활용하여 실시간 방향 안내
- 사용자의 현재 위치 기반 방위각 계산
- 화살표 UI로 목표 지점 방향 표시

### 2. 위치 정보 동의
- 사용자에게 위치 정보 활용 동의 요청
- iOS 디바이스의 DeviceOrientation 권한 요청
- Geolocation API를 통한 실시간 위치 추적

## 기술 스택 및 제약사항

### 프레임워크
- **Next.js 16.1.6** (App Router 기준)
- **React 19.2.3**
- **TypeScript 5**

### 스타일링
- **Tailwind CSS 4**
- 인라인 스타일 (필요 시)

### 구조 제약사항
- ❌ **백엔드 사용 안 함** (Spring Boot, DB, 인증 모두 제외)
- ✅ **Client-side 처리 우선**
- ✅ **Next.js API Route 사용 가능** (필요 시)
- ⚠️ **외부 라이브러리 사용 가능하나 과도한 의존성 지양**

### 비기능 요구사항
- ❌ 로그인 / 회원가입
- ❌ 사용자 데이터 저장
- ❌ 히스토리 / 로그 저장

## 현재 구현 상태

### 완료된 기능
1. **위치 추적**
   - Geolocation API를 통한 실시간 위치 감지
   - `watchPosition`으로 지속적인 위치 업데이트
   - 고정밀도 모드 활성화

2. **디바이스 방향 감지**
   - **Android**: AbsoluteOrientationSensor API 우선 사용 (Generic Sensor API)
   - **iOS**: webkitCompassHeading 사용 (진북 기준)
   - **Fallback**: DeviceOrientationEvent (absolute/relative 구분)
   - iOS 권한 요청 처리 (`DeviceOrientationEvent.requestPermission`)

   **안정화 최적화 (v2.3 Fast Response)**:
     - **Single EMA**: α=0.35 (빠른 반응)
     - **Outlier Rejection**: 60도 이상 급변만 무시 (완화)
     - **Warmup Period**: 초기 10샘플은 즉시 수용
     - **mod360 함수**: 0~360 경계 처리 개선
     - **angleDiff 함수**: 최단 거리 각도 차이 계산 (-180~180)
     - 작은 변화 감지 (Threshold): 0.5도 이상 변화 반영 (민감)
     - Throttling: 50ms 간격으로 센서 데이터 처리 (빠름)
     - 빠른 애니메이션: 0.2s ease-out transition

3. **방위각 계산**
   - Haversine 공식 기반 bearing 계산
   - 사용자 위치와 목표 좌표 간 방향 계산

4. **UI 구현**

   **나침반 모드 (`/`):**
   - 화면 중앙 나침반 화살표 (빨간색, 단순)
   - 실시간 회전 애니메이션 (0.2s ease-out)
   - 방향 안내 텍스트 카드 (심플한 디자인)
   - 방위각 정보 표시 (현재/목표 방향)
   - 거리 정보 표시 (km/m 단위)
   - 상세 정보 아코디언
   - 레이더 모드 전환 버튼

   **레이더 모드 (`/radar`):**
   - 원형 레이더 디스플레이 (SVG)
   - 중앙 사용자 마커 (파란색 점)
   - 목표 지점 마커 (빨간색 점 + 펄스)
   - 거리선 (점선)
   - 동심원 3개 (스케일 표시)
   - 십자선 및 방위 표시
   - 자동/수동 줌 컨트롤
   - 나침반 모드 전환 버튼

## 핵심 로직

### 방위각 계산 (Haversine Bearing)
```typescript
const calculateBearing = (lat1, lon1, lat2, lon2) => {
  const φ1 = toRad(lat1);
  const φ2 = toRad(lat2);
  const Δλ = toRad(lon2 - lon1);

  const y = Math.sin(Δλ) * Math.cos(φ2);
  const x = Math.cos(φ1) * Math.sin(φ2) -
            Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);

  return (toDeg(Math.atan2(y, x)) + 360) % 360;
};
```

### 디바이스 방향 처리 및 안정화 (v2.0)

**센서 우선순위:**
1. **Android**: `AbsoluteOrientationSensor` (Generic Sensor API) - 가장 정확
2. **iOS**: `webkitCompassHeading` - 진북 기준
3. **Fallback**: `DeviceOrientationEvent` (absolute/relative)

**안정화 알고리즘 v2.3 (Fast Response):**
```typescript
// 1. 유틸리티 함수
const mod360 = (deg: number) => ((deg % 360) + 360) % 360;

const angleDiff = (a: number, b: number) => {
  let diff = a - b;
  while (diff > 180) diff -= 360;
  while (diff < -180) diff += 360;
  return diff; // -180 ~ 180
};

// 2. Single EMA (빠른 반응)
const smoothHeadingEMA = (newHeading: number) => {
  const ALPHA = 0.35;  // 평활화 계수 (높을수록 빠른 반응)

  if (lastSmoothed === null) return newHeading;

  // Outlier Rejection: 60도 이상 급변만 무시 (완화)
  const rawDiff = Math.abs(angleDiff(newHeading, lastSmoothed));
  if (rawDiff > 60 && sensorReadCount > 10) {
    return lastSmoothed; // 이전 값 유지
  }

  // Single EMA (빠른 반응)
  const diff = angleDiff(newHeading, lastSmoothed);
  let smoothed = lastSmoothed + ALPHA * diff;
  return mod360(smoothed);
};

// 3. 초기 안정화 기간 (단축)
const WARMUP_SAMPLES = 10;
if (sensorReadCount <= WARMUP_SAMPLES) {
  // 초기에는 모든 값 수용 (빠른 초기화)
  setHeading(smoothed);
} else {
  // 안정화 후에도 민감하게 반응
  if (Math.abs(angleDiff(smoothed, lastHeading)) < 0.5) return;
  setHeading(smoothed);
}

// 4. AbsoluteOrientationSensor (Android)
const sensor = new AbsoluteOrientationSensor({ frequency: 60 });
sensor.onreading = () => {
  // quaternion을 euler 각도로 변환
  const yaw = Math.atan2(2*(w*z + x*y), 1 - 2*(y*y + z*z));
  let heading = mod360(yaw * 180 / Math.PI);

  const smoothed = smoothHeadingEMA(heading);
  // ... threshold 체크 및 업데이트
};

// 5. Throttling (50ms 간격 - 빠름)
// 6. CSS transition (0.2s ease-out - 빠름)
```

**주요 변경점:**
- Double EMA → Single EMA (반응 속도 2배)
- ALPHA 0.15 → 0.35 (빠른 반응)
- Outlier threshold 30° → 60° (완화)
- Change threshold 3.0° → 0.5° (민감)
- Throttling 200ms → 50ms (4배 빠름)
- CSS transition 0.8s → 0.2s (4배 빠름)

**센서별 특징:**
- `AbsoluteOrientationSensor`: 진북 기준, 자이로+자력계+가속도계 융합, 가장 정확
- `webkitCompassHeading`: iOS Safari 전용, 진북 기준, 안정적
- `DeviceOrientation (absolute)`: 진북 기준, 브라우저 지원 제한적
- `DeviceOrientation (relative)`: 초기 화면 방향 기준, 부정확 (사용 비권장)

### 화살표 회전 (개선됨)
```typescript
// bearing: 목표 방향 (진북 기준, 0~360)
// heading: 현재 기기 방향 (진북 기준, 0~360)
// rotation: 기기에서 목표까지의 상대 각도

const bearing = calculateBearing(userLat, userLon, targetLat, targetLon);
let rotation = angleDiff(bearing, heading); // -180 ~ 180
rotation = mod360(rotation); // 0 ~ 360

arrowRef.current.style.transform = `rotate(${rotation}deg)`;
```

**주요 개선점:**
- `angleDiff` 함수로 최단 경로 계산
- 0~360 경계에서 360도 점프 방지
- bearing과 heading 모두 진북 기준으로 통일

## 파일 구조
```
compass/
├── app/
│   ├── page.tsx          # 메인 나침반 페이지
│   └── radar/
│       └── page.tsx      # 레이더 모드 페이지
├── package.json
├── tsconfig.json
├── tailwind.config.js
└── .agent.md             # 이 파일
```

## 향후 확장 시 고려사항

### 1. 다중 목표 지점 지원
- 여러 좌표를 설정할 수 있는 기능
- 목표 지점 선택 UI
- 로컬 스토리지 활용 (사용자 데이터 저장 없이)

### 2. 거리 정보 ✅ (완료)
- ✅ Haversine 공식으로 현재 위치와 목표 지점 간 거리 계산
- ✅ km/m 단위 표시

### 3. UI/UX 개선 ✅ (완료)
- ✅ 더 정교한 나침반 디자인
- ✅ 배경에 실제 나침반 다이얼 추가
- ✅ 북쪽(N), 동쪽(E), 서쪽(W), 남쪽(S) 표시
- 다크 모드 지원 (추후)

### 4. PWA 지원
- `manifest.json` 추가
- 서비스 워커 등록
- 홈 화면에 추가 가능
- 오프라인 지원

### 5. 성능 최적화 ✅ (완료)
- ✅ 센서 데이터 throttling (150ms 간격)
- ✅ 작은 변화 무시 (2도 threshold)
- ✅ 가중 이동 평균 (10개 샘플)
- ✅ 불필요한 리렌더링 방지
- 추가 배터리 최적화 (추후)

### 6. 에러 핸들링 강화
- 위치 정보 거부 시 안내 메시지
- 센서 미지원 디바이스 대응
- 네트워크 오류 처리

### 7. 접근성 개선
- ARIA 레이블 추가
- 스크린 리더 지원
- 키보드 네비게이션

### 8. 공유 기능
- 특정 좌표 URL 파라미터로 전달
- 딥링크 지원
- QR 코드 생성

### 9. 좌표 입력 기능
- 사용자가 직접 좌표 입력
- 주소 검색 (Geocoding API 활용)
- 즐겨찾기 (로컬 스토리지)

### 10. 테스트 추가
- 단위 테스트 (방위각 계산 로직)
- E2E 테스트 (Playwright/Cypress)
- 모바일 디바이스 테스트

## 주의사항

### 센서 및 권한
- iOS는 HTTPS 환경에서만 DeviceOrientation 작동
- iOS 13+ 부터 권한 요청 필수
- Android는 대부분 자동 허용

### 정확도 및 안정성

**센서 선택에 따른 정확도:**
1. **AbsoluteOrientationSensor (Android)**: ±5° 이내 (최고 정확도)
   - 자이로 + 자력계 + 가속도계 센서 융합
   - 실시간 캘리브레이션
   - Chrome 67+ 지원

2. **webkitCompassHeading (iOS)**: ±10° 이내
   - iOS Safari 전용, 진북 기준
   - 안정적이지만 iOS 환경 의존

3. **DeviceOrientation (absolute)**: ±15° 이내
   - 브라우저/기기별 편차 큼
   - 자력계 품질에 의존

4. **DeviceOrientation (relative)**: ±30° 이상 (부정확)
   - 진북이 아닌 초기 화면 방향 기준
   - 나침반 용도로 부적합

**환경별 정확도:**
- 실내: GPS 정확도 저하 가능 (위치는 영향, 방향은 무관)
- 자기장 간섭: 전자기기, 금속 구조물 근처에서 ±20° 이상 오차
- 디바이스 케이스: 자석 케이스 사용 시 부정확
- 센서 캘리브레이션: 8자 움직임으로 캘리브레이션 권장

**안정화 파라미터 조정 (v2.3):**
- `ALPHA` (0.35): EMA 평활화 계수
  - 낮을수록 (0.1~0.2): 부드럽지만 느린 반응
  - 높을수록 (0.4~0.6): 매우 빠른 반응, 약간 떨림
  - **현재 (0.35)**: 빠른 반응 + 적절한 안정성
- `OUTLIER_THRESHOLD` (60도): 급격한 변화 무시 임계값
  - 센서 오류 판정 기준 (완화됨)
- `THROTTLE_MS` (50ms): 센서 업데이트 주기
  - 높을수록: 배터리 절약, 더 안정적
  - 낮을수록: 빠른 반응
  - **현재 (50ms)**: 초당 20회 업데이트
- `CHANGE_THRESHOLD` (0.5도): 반영할 최소 변화량
  - 높을수록: 안정적이지만 덜 민감
  - 낮을수록: 매우 민감, 작은 움직임 감지
  - **현재 (0.5도)**: 정밀한 추적
- `WARMUP_SAMPLES` (10개): 초기 안정화 샘플 수
  - 초기 방향 감지 속도 조절
- CSS transition (0.2s): 애니메이션 속도
  - **현재 (0.2s)**: 즉각적인 시각 피드백

**현재 설정 (Fast Response):**
- 빠른 반응 속도 우선 (벤치마크 수준)
- 실시간 추적
- 정밀한 방향 감지
- 작은 움직임도 즉시 반영

**더 빠르게 (극한 설정):**
```typescript
ALPHA = 0.5
THROTTLE_MS = 30
CHANGE_THRESHOLD = 0.1
CSS transition = 0.1s
```

**더 안정적으로 (균형 설정):**
```typescript
ALPHA = 0.25
THROTTLE_MS = 100
CHANGE_THRESHOLD = 1.0
CSS transition = 0.3s
```

### 브라우저 지원

**AbsoluteOrientationSensor:**
- Chrome 67+ (Android)
- Edge 79+ (Android)
- Samsung Internet 9.2+
- ❌ iOS Safari (미지원)
- ❌ Firefox (미지원)

**DeviceOrientationEvent:**
- iOS Safari 13+ (HTTPS 필수, 권한 요청 필수)
- Chrome Mobile (Android)
- Firefox Mobile
- Samsung Internet

**권장 환경:**
- Android: Chrome 최신 버전 (AbsoluteOrientationSensor 지원)
- iOS: Safari 최신 버전 (webkitCompassHeading 지원)
- HTTPS 필수 (특히 iOS)
- 데스크톱 브라우저는 센서 미지원

## 개발 가이드

### 로컬 개발
```bash
npm run dev
```
- 모바일 디바이스에서 테스트 필요
- 로컬 네트워크 IP로 접근 (예: http://192.168.0.x:3000)
- HTTPS 필요 시 ngrok 또는 로컬 인증서 사용

### 배포
```bash
npm run build
npm run start
```
- Vercel, Netlify 등 정적 호스팅 권장
- HTTPS 필수 (센서 권한 요청을 위해)

### 환경 변수 (확장 시)
현재는 사용하지 않지만, 향후 API 키 등 추가 시:
```
NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=...
```

## 참고 자료
- [Geolocation API - MDN](https://developer.mozilla.org/en-US/docs/Web/API/Geolocation_API)
- [DeviceOrientationEvent - MDN](https://developer.mozilla.org/en-US/docs/Web/API/DeviceOrientationEvent)
- [Haversine Formula](https://en.wikipedia.org/wiki/Haversine_formula)
- [Next.js App Router](https://nextjs.org/docs/app)
